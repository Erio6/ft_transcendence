{% extends 'djangoProject/home.html' %}

{% block content %}
 <h1>My Friends</h1>
<div class="my-friends">

<!--    Add friends section-->
    <div class="add-friends"><h3>Add Friends</h3>
        <a>Search</a>
    <form method="GET" action="{% url 'friends:friends_overview' %}">
            <input type="text" name="q" value="{{ query }}" placeholder="Search for a friend...">
            <button type="submit">Search</button>
    </form>
    {% if query %}
        <a>Search Results</a>
        {% if search_results %}
            <ul>
                {% for user in search_results %}
                    <li>
                        {{ user.user.username }}
                        <form action="{% url 'friends:send_friend_request' user.user.id %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" >Add Friend</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p> No users found for "{{ query }}".</p>
        {% endif %}
    {% endif %}
        <a>Pending invitation sent</a>
        {% for request in outgoing_requests %}
            <li>
                {{ request.receiver.user.userprofile }} (Pending)
                <form action="{% url 'friends:cancel_friend_request' request.id %}" method="post" >
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning btn-sm">Cancel</button>
                </form>
            </li>
        {% empty %}
            <li class="list-group-item">No invitation sent.</li>
        {% endfor %}
    </div>

<!--    Friend lists section-->
    <div class="friend-list"><h3>Friend List</h3>
        {% if friends %}
    <ul>
        {% for friend in friends %}
           <li>
                <span class="status-dot {% if friend.user.userprofile.is_online %} online {% else %} offline {% endif %}"></span>
                <img class="avatar" src="{{ friend.user.userprofile.avatar.url }}" alt="Profile Image">
                <span class="username">{{ friend.user.username }}</span>
                <form class="remove-form" method="POST" action="{% url 'friends:remove_friend' friend.user.id %}" onsubmit="return confirmRemove('{{ friend.user.username }}')">
                    {% csrf_token %}
                    <button type="submit" class="remove-btn">
                        Remove
                    </button>
                </form>
            </li>
        {% endfor %}
    </ul>
    {% else %}
        <p>You have no friends.</p>
   {% endif %}
    </div>

<!--    Friend request received section-->
    <div class="friend-request-received">
        <h3>Friend request received</h3>
    <ul>
        {% for request in incoming_requests %}
            <li>
                {{ request.sender.user.userprofile }}
                <div>
                    <form action="{% url 'friends:accept_friend_request' request.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-sm">Accept</button>
                    </form>
                    <form action="{% url 'friends:decline_friend_request' request.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-secondary btn-sm">Decline</button>
                    </form>
                </div>
            </li>
        {% empty %}
            <li class="list-group-item">No incoming friend requests.</li>
        {% endfor %}
    </ul>
    </div>
</div>

<script>
    function confirmRemove(username) {
        return confirm(`Are you sure you want to remove ${username} from your friends list?`);
    }
</script>
{% endblock %}
